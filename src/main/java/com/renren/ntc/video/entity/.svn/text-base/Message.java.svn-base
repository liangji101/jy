package com.renren.ntc.video.entity;

import com.mongodb.BasicDBObject;
import com.mongodb.DBObject;
import com.renren.ntc.video.utils.Constants;
import net.sf.json.JSONObject;
import org.apache.commons.lang.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.Serializable;
import java.util.Iterator;

/**
 * Author: Weiliang Shuai
 * Contact: weiliang.shuai@renren-inc.com
 * Date: 12-6-21
 * Time: 下午3:40
 */
public class Message implements Serializable{
    
	private static final Logger logger = LoggerFactory.getLogger(Message.class);
	
	private static final long serialVersionUID = 1L;
	
    private Long mid;
    
    private Integer srcUid;

    /**
     * 视频拥有者的uid
     */
    private Integer desUid;
    
    private String srcUserName;
    
    private String desUserName;

    private String title = "";

    private String content = "";
    
    private Integer type = Integer.valueOf(0);;
    
    private String video = "";
    
    private String srcHeadUrl = "";
    
    private String action = "";

    private JSONObject videoJson = null;

    /**
     * 消息创建时间
     */
    private long createAt = 0;
    
    /**
     * 创建时间的显示，如“5分钟前”,"一天前"
     */
    private String time;

    private long eid;

    public long getEid() {
        return eid;
    }

    public void setEid(long eid) {
        this.eid = eid;
    }

    public String getTime() {
		return time;
	}

	public void setTime(String time) {
		this.time = time;
	}

	/**
     * 目标用户的headUrl
     */
    private String desHeadUrl = "";

    /**
     * 0表示未读，1表示已读
     */
    private Integer read = Integer.valueOf(0);

    public Message() {
    }

    /**
     * 0表示未读，1表示已读
     * @return 0表示未读，1表示已读
     */
    public Integer getRead() {
        return read;
    }

    /**
     * 0表示未读，1表示已读
     * @param read 标志位，0表示未读，1表示已读
     */
    public void setRead(Integer read) {
        this.read = read;
    }

    public String getContent() {
        return content;
    }

    public void setContent(String content) {
        this.content = content;
    }

    public String getTitle() {
        return title;
    }

    public void setTitle(String title) {
        this.title = title;
    }

    public Integer getSrcUid() {
        return srcUid;
    }

    public void setSrcUid(Integer srcUid) {
        this.srcUid = srcUid;
    }


    public void setSrc_uid(Integer src_uid) {
        this.srcUid = src_uid;
    }

    public Long getMid() {
        return mid;
    }

    public void setMid(Long mid) {
        this.mid = mid;
    }

    public String getVideo() {
        return video;
    }

    public void setVideo(String video) {
        this.video = video;
    }
    
    public String getVideoId(){
        if(videoJson == null && !StringUtils.isEmpty(video)) {
            videoJson = JSONObject.fromObject(video);
        }
        if(StringUtils.isEmpty(video)){
        	return "";
        }
        Object videoId = videoJson.get(Constants.MSG_VIDEO_ID);
        if(videoId == null) {
            return "";
        }
        return videoJson.get(Constants.MSG_VIDEO_ID).toString();
    }
    
    public String getVideoTitle(){
        if(videoJson == null && !StringUtils.isEmpty(video)) {
            videoJson = JSONObject.fromObject(video);
        }
        if(StringUtils.isEmpty(video)){
        	return "";
        }

        Object msgTitle = videoJson.get(Constants.MSG_VIDEO_TITLE);
        if(msgTitle == null) {
            return "";
        }

        return videoJson.get(Constants.MSG_VIDEO_TITLE).toString();
    }

    public Integer getType() {
        return type;
    }

    public void setType(Integer type) {
        this.type = type;
    }

    public Integer getDesUid() {
        return desUid;
    }

    public void setDesUid(Integer desUid) {
        this.desUid = desUid;
    }

    public void setDes_uid(Integer des_uid) {
        this.desUid = des_uid;
    }

    public String getSrcHeadUrl() {
        return srcHeadUrl;
    }

    public void setSrcHeadUrl(String srcHeadUrl) {
        this.srcHeadUrl = srcHeadUrl;
    }
    
    public void setSrc_head_url(String src_head_url) {
        this.srcHeadUrl = src_head_url;
    }

    public String getDesHeadUrl() {
        return desHeadUrl;
    }

    public void setDesHeadUrl(String desHeadUrl) {
        this.desHeadUrl = desHeadUrl;
    }
    
    public void setDes_head_url(String des_head_url) {
        this.desHeadUrl = des_head_url;
    }

    public String getAction() {
        return action;
    }

    public void setAction(String action) {
        this.action = action;
    }

    public String getDesUserName() {
        return desUserName;
    }

    public void setDesUserName(String desUserName) {
        this.desUserName = desUserName;
    }

    public void setDes_user_name(String des_user_name) {
        this.desUserName = des_user_name;
    }

    public String getSrcUserName() {
        return srcUserName;
    }

    public void setSrcUserName(String srcUserName) {
        this.srcUserName = srcUserName;
    }
    
    public void  setSrc_user_name(String src_user_name) {
        this.srcUserName = src_user_name;
    }

    public long getCreateAt() {
        return createAt;
    }

    public void setCreateAt(long createAt) {
        this.createAt = createAt;
    }

    public void setCreate_at(long create_at) {
        this.createAt = create_at;
    }

    @Override
    public String toString() {
        return "Message{" +
                "action='" + action + '\'' +
                ", mid=" + mid +
                ", srcUid=" + srcUid +
                ", desUid=" + desUid +
                ", srcUserName='" + srcUserName + '\'' +
                ", desUserName='" + desUserName + '\'' +
                ", title='" + title + '\'' +
                ", content='" + content + '\'' +
                ", type=" + type +
                ", video='" + video + '\'' +
                ", srcHeadUrl='" + srcHeadUrl + '\'' +
                ", createAt=" + createAt +
                ", desHeadUrl='" + desHeadUrl + '\'' +
                ", read=" + read +
                '}';
    }

    public BasicDBObject toMongoDBObject() {
        BasicDBObject msg = new BasicDBObject();
        msg.put(Constants.MSG_SRC_UID, srcUid);
        msg.put(Constants.MSG_TITLE, title);
        msg.put(Constants.MSG_CONTENT, content);
        msg.put(Constants.MID, mid);
        msg.put(Constants.MSG_TYPE, type);
        msg.put(Constants.MSG_VIDEO, videoToMongoDBObject());
        msg.put(Constants.MSG_READ, read);
        msg.put(Constants.MSG_DES_UID, desUid);
        msg.put(Constants.MSG_CREATE_AT, createAt);
        return msg;
    }

    private DBObject videoToMongoDBObject() {
        BasicDBObject dbVideo = new BasicDBObject();
        if(video == null || "".equals(video)) {
            return  dbVideo;
        }
        JSONObject json = JSONObject.fromObject(video);
        Iterator iterator = json.keys();
        while (iterator.hasNext()) {
            Object key = iterator.next();
            dbVideo.put(key.toString(), json.get(key.toString()));
        }

        return dbVideo;
    }

    public Message fromMongoDBObject(DBObject dbObject) {
        this.setMid((Long) dbObject.get(Constants.MID));
        this.setSrcUid((Integer) dbObject.get(Constants.MSG_SRC_UID));
        this.setTitle(dbObject.get(Constants.MSG_TITLE).toString());
        this.setContent(dbObject.get(Constants.MSG_CONTENT).toString());
        this.setType((Integer) dbObject.get(Constants.MSG_TYPE));
        this.setVideo(dbObject.get(Constants.MSG_VIDEO).toString());
        this.setRead((Integer) dbObject.get(Constants.MSG_READ));
        this.setDesUid((Integer) dbObject.get(Constants.MSG_DES_UID));
        this.setCreateAt((Long) dbObject.get(Constants.MSG_CREATE_AT));
        return this;
    }

    public static JSONObject toJSONObject(DBObject dbObject) {
        JSONObject jsonObject = new JSONObject();
        jsonObject.put(Constants.MID, dbObject.get(Constants.MID));
        jsonObject.put(Constants.MSG_SRC_UID, dbObject.get(Constants.MSG_SRC_UID));
        jsonObject.put(Constants.MSG_DES_UID, dbObject.get(Constants.MSG_DES_UID));
        jsonObject.put(Constants.MSG_TITLE, dbObject.get(Constants.MSG_TITLE));
        jsonObject.put(Constants.MSG_CONTENT, dbObject.get(Constants.MSG_CONTENT));
        jsonObject.put(Constants.MSG_TYPE, dbObject.get(Constants.MSG_TYPE));
        jsonObject.put(Constants.MSG_VIDEO, dbObject.get(Constants.MSG_VIDEO));
        jsonObject.put(Constants.MSG_READ, dbObject.get(Constants.MSG_READ));
        jsonObject.put(Constants.MSG_CREATE_AT, dbObject.get(Constants.MSG_CREATE_AT));
        return jsonObject;
    }


    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;

        Message message = (Message) o;

        if (content != null ? !content.equals(message.content) : message.content != null) return false;
        if (desUid != null ? !desUid.equals(message.desUid) : message.desUid != null) return false;
        if (srcUid != null ? !srcUid.equals(message.srcUid) : message.srcUid != null) return false;
        if (type != null ? !type.equals(message.type) : message.type != null) return false;
        if (video != null ? !video.equals(message.video) : message.video != null) return false;

        return true;
    }

    @Override
    public int hashCode() {
        int result = srcUid != null ? srcUid.hashCode() : 0;
        result = 31 * result + (desUid != null ? desUid.hashCode() : 0);
        result = 31 * result + (content != null ? content.hashCode() : 0);
        result = 31 * result + (type != null ? type.hashCode() : 0);
        result = 31 * result + (video != null ? video.hashCode() : 0);
        return result;
    }

    public static MsgBuilder getBuilder() {
        return new MsgBuilder();
    }

    public static class MsgBuilder {
        private Message message;

        MsgBuilder() {
            this.message = new Message();
        }

        public MsgBuilder srcUid(int srcUid) {
            this.message.setSrcUid(srcUid);
            return this;
        }
        
        public MsgBuilder title(String title) {
            this.message.setTitle(title);
            return this;
        }
        
        public MsgBuilder content(String content) {
            this.message.setContent(content);
            return this;
        }

        public MsgBuilder type(Integer type) {
            this.message.setType(type);
            return this;
        }
        
        public MsgBuilder mid(Long mid) {
            this.message.setMid(mid);
            return this;
        }

        public MsgBuilder video(String ext) {
            this.message.setVideo(ext);
            return this;
        }
        
        public MsgBuilder desUid(Integer desUid) {
            this.message.setDesUid(desUid);
            return this;
        }
        
        public MsgBuilder srcHeadUrl(String srcHeadUrl) {
            this.message.setSrcHeadUrl(srcHeadUrl);
            return this;
        }
        
        public MsgBuilder desHeadUrl(String desUrl) {
            this.message.setDesHeadUrl(desUrl);
            return this;
        }
        
        public MsgBuilder srcUserName(String srcUserName) {
            this.message.setSrcUserName(srcUserName);
            return this;
        }
        
        public MsgBuilder desUserName(String desUserName) {
            this.message.setDesUserName(desUserName);
            return this;
        }

        public MsgBuilder createTime() {
            this.message.setCreateAt(System.currentTimeMillis());
            return this;
        }

        public MsgBuilder eid(long eid) {
            this.message.setEid(eid);
            return this;
        }
        
        public Message getMessage(){
            return this.message;
        }
        
    }

}
