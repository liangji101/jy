package com.renren.ntc.video.controllers;

import net.paoding.rose.web.Invocation;
import net.paoding.rose.web.annotation.Param;
import net.paoding.rose.web.annotation.Path;
import net.paoding.rose.web.annotation.rest.Get;
import net.sf.json.JSONArray;
import net.sf.json.JSONObject;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;

import com.renren.ntc.video.entity.Sharement;
import com.renren.ntc.video.formbean.Video;
import com.renren.ntc.video.service.ShareService;
import com.renren.ntc.video.utils.BaseUtil;
import com.renren.ntc.video.utils.Constants;
import com.renren.ntc.video.utils.ImageSizeUtil;
import com.renren.ntc.video.utils.JsonResponse;
import com.renren.ntc.video.utils.MemcachedUtil;
import com.renren.ntc.video.utils.ImageSizeUtil.ImageSize;
import com.renren.ntc.video.utils.renren.utils.HttpURLUtils;

/**
 * Author: Weiliang Shuai
 * Contact: weiliang.shuai@renren-inc.com
 * Date: 12-7-11
 * Time: 下午4:44
 */
@Path("")
public class HomeController {

	private static final Logger logger = LoggerFactory.getLogger(HomeController.class);
	
	@Autowired
	private ShareService shareService;
	
    @Get("")
    public String index(Invocation inv){
        String userAgent = inv.getRequest().getHeader("user-agent");
        logger.info("user agent: " + userAgent);
//        logger.info(inv.getRequest().getRemoteAddr());
        if(userAgent!= null && userAgent.contains("iPhone")) {
            return "iphone_index.vm";
        }
        return "index.vm";
    }
    
    @Get("download")
    public String raydvDownload(@Param("ref")String ref){
    	if(ref == null){
    		ref = "没有传ref参数";
    	}
    	logger.info("***---raydv download---下载光影DV的ref是："+ref);
    	return "r:http://itunes.apple.com/cn/app/guang-yingdv/id552718710?ls=1&mt=8";
    }
    
    @Get("musicDownload")
    public String musicDownload(@Param("ref")String ref){
    	if(ref == null){
    		ref = "没有传ref参数";
    	}
    	logger.info("***---music download---下载人人电台的ref是："+ref);
    	return "r:http://itunes.apple.com/cn/app/ren-ren-dian-tai/id546611769?ls=1&mt=8";
    }
    
    @Get("commentme")
    public String commentme(){
    	logger.info("***commentme");
    	return "r:http://itunes.apple.com/cn/app/guang-yingdv/id552718710?ls=1&mt=8";
    }

    @Get("iphone")
    public String iphoneIndex(){
        return "iphone_index.vm";
    }

    @Get("iphone/dev")
    public String iphoneDevIndex(){
        return "iphone_dev_index.vm";
    }

    @Get("resourceNotFound")
    public String resourceNotFound(Invocation inv){
    	String userAgent = inv.getRequest().getHeader("user-agent");
    	if(userAgent!= null && userAgent.contains("RRCam")) {
    		return "@" + JsonResponse.formFailResponse(Constants.ErrorCode.FAIL);
        }
    	return "404";
    }

    @Get("serverError")
    public String serverError(){
    	return "500";
    }

    @Get("videoNotFound")
    public String videoNotFound(){
        return "video_not_found";
    }

    @Get("userNotFound")
    public String userNotFound(){
        return "user_not_found";
    }
    
    @Get("videoViewDeny")
    public String videoNotCommitted(){
    	return "video_not_committed";
    }

    @Get("renren")
    public String renren() {
        return "renren";
    }
//    产品需要活动下线
//    @Get("event")
//    public String event(Invocation inv) {
//    	long shareId = MemcachedUtil.getInstance().getActiveHeaderVideo();
//    	Sharement video = shareService.getShareByShareId(shareId);
//    	if (video == null){
//    		video = shareService.getShareByShareId(25745);
//    	}
//    	Video v = video.getVideo();
//        int height = 0;
//        int width = 0;
//        if (v != null) {
//            height = v.getCover_height();
//            width = v.getCover_width();
//        } else {
//            logger.error("获取视频长宽信息出错,横版还是竖版判断会出错");
//        }
//    	inv.addModel("height", height);
//        inv.addModel("width", width);
//        inv.addModel("shareId", shareId);
//    	inv.addModel("vid", BaseUtil.getTransferedVid(video.getVid()));
//        inv.addModel("swfUrl", BaseUtil.getPlayURL(video.getVid()));
//        inv.addModel("flashVars", BaseUtil.getFlashVars(video.getVid(), shareId, width, height, 0, "http://www.uume.com/share/"+shareId, "off"));
//        return "event_3";
//    }
    
//    @Get("video/{shareId:[0-9]+}")
//    public String demo(Invocation inv,@Param("shareId") long shareId) {
//    	Sharement video = shareService.getShareByShareId(shareId);
//    	if (video == null){
////    		video = shareService.getShareByShareId(25745);
//    		return "r:http://itunes.apple.com/cn/app/guang-yingdv/id552718710?ls=1&mt=8";
//    	}
//    	try{
//    		String url = video.getVideo().getPlayUrl();
//        	String res = HttpURLUtils.doGet(url);
//        	String cover = video.getVideo().getCover();
//        	String title = video.getVideo().getTitle();
//        	JSONObject json = JSONObject.fromObject(res);
//        	JSONArray jar = BaseUtil.paserPlayUrl(json);
//        	String playUrl = null;
//        	for(int i =0 ; i < jar.size() ;i++){
//        		JSONObject js = new JSONObject();
//        		js = (JSONObject) jar.get(i);
//        		playUrl = js.getString("qqvga");
//        	}
//        	ImageSize size = ImageSizeUtil.getRealSize(cover);
//        	inv.addModel("playUrl", playUrl);
//        	if (size == null){
//        		return "r:http://itunes.apple.com/cn/app/guang-yingdv/id552718710?ls=1&mt=8";
//        	}
//        	String width = "100%";
//        	if (size.getWidth() < size.getHeight()){
//        		width = (size.getWidth()*1.0)/size.getHeight() * 100 + "%";
//        	}
//        	inv.addModel("width", width);
//        	inv.addModel("cover", cover);
//        	inv.addModel("title", title);
//            return "demo";
//    	}catch(Exception e){
//    		e.printStackTrace();
//    		return "r:http://itunes.apple.com/cn/app/guang-yingdv/id552718710?ls=1&mt=8";
//    	}
//    }
}
